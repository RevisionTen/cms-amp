(function(){var TAG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging="amp-viewer-messaging";var CHANNEL_OPEN_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging="channelOpen";var HANDSHAKE_POLL_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging="handshake-poll";var APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging="__AMPHTML__";var MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging={REQUEST:"q",RESPONSE:"s"};
var RequestHandler$$module$extensions$amp_viewer_integration$0_1$messaging$messaging;function parseMessage$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(message){if(typeof message!="string")return message;if(message.charAt(0)!="{")return null;try{return JSON.parse(message)}catch(e){return null}}var WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging=function(win,origin,target){this.win_=win;this.origin_=origin;this.target_=target};
WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.addEventListener=function(eventType,handler){var $jscomp$this=this;this.win_.addEventListener("message",function(event){if(event.origin==$jscomp$this.origin_&&event.source==$jscomp$this.target_)handler(event)})};
WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.postMessage=function(data){var targetOrigin=this.origin_==="null"?"*":this.origin_;this.target_.postMessage(data,targetOrigin)};WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.start=function(){};
var Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging=function(win,port,opt_isWebview,opt_token,opt_verifyToken){this.win_=win;this.port_=port;this.isWebview_=!!opt_isWebview;this.token_=opt_token||null;this.verifyToken_=!!opt_verifyToken;this.requestIdCounter_=0;this.waitingForResponse_={};this.messageHandlers_={};this.defaultHandler_=null;this.port_.addEventListener("message",this.handleMessage_.bind(this));this.port_.start()};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.initiateHandshakeWithDocument=function(target,opt_token){return new Promise(function(resolve){var intervalRef=setInterval(function(){var channel=new MessageChannel;var pollMessage={app:APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,name:HANDSHAKE_POLL_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging};target.postMessage(pollMessage,"*",[channel.port2]);var port=channel.port1;var listener=
function(event){var message=parseMessage$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(event.data);if(!message)return;if(message.app===APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging&&message.name===CHANNEL_OPEN_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging){clearInterval(intervalRef);port.removeEventListener("message",listener);var messaging=new Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(null,port,
false,opt_token,true);messaging.sendResponse_(message.requestid,CHANNEL_OPEN_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,null);resolve(messaging)}};port.addEventListener("message",listener);port.start()},1E3)})};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.waitForHandshakeFromDocument=function(source,target,origin,opt_token){return new Promise(function(resolve){var listener=function(event){var message=parseMessage$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(event.data);if(!message)return;if(event.origin==origin&&(!event.source||event.source==target)&&message.app===APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging&&message.name===CHANNEL_OPEN_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging){source.removeEventListener("message",
listener);var port=new WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(source,origin,target);var messaging=new Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(null,port,false,opt_token,true);messaging.sendResponse_(message.requestid,CHANNEL_OPEN_MSG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,null);resolve(messaging)}};source.addEventListener("message",listener)})};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.registerHandler=function(messageName,requestHandler){this.messageHandlers_[messageName]=requestHandler};Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.unregisterHandler=function(messageName){delete this.messageHandlers_[messageName]};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.setDefaultHandler=function(requestHandler){this.defaultHandler_=requestHandler};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.handleMessage_=function(event){var message=parseMessage$$module$extensions$amp_viewer_integration$0_1$messaging$messaging(event.data);if(!message||message.app!==APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging)return;if(this.token_&&this.verifyToken_&&message.messagingToken!==this.token_){this.logError_(TAG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging+": handleMessage_ error: ",
"invalid token");return}if(message.type===MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.REQUEST)this.handleRequest_(message);else if(message.type===MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.RESPONSE)this.handleResponse_(message)};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.sendRequest=function(messageName,messageData,awaitResponse){var $jscomp$this=this;var requestId=++this.requestIdCounter_;var promise=undefined;if(awaitResponse)promise=new Promise(function(resolve,reject){$jscomp$this.waitingForResponse_[requestId]={resolve:resolve,reject:reject}});this.sendMessage_({app:APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,requestid:requestId,type:MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.REQUEST,
name:messageName,data:messageData,rsvp:awaitResponse});return promise};Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.sendResponse_=function(requestId,messageName,messageData){this.sendMessage_({app:APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,requestid:requestId,type:MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.RESPONSE,name:messageName,data:messageData})};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.sendResponseError_=function(requestId,messageName,reason){var errString=this.errorToString_(reason);this.logError_(TAG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging+": sendResponseError_, message name: "+messageName,errString);this.sendMessage_({app:APP$$module$extensions$amp_viewer_integration$0_1$messaging$messaging,requestid:requestId,type:MessageType$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.RESPONSE,
name:messageName,data:null,error:errString})};Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.sendMessage_=function(message){var finalMessage=Object.assign(message,{});if(this.token_&&!this.verifyToken_)finalMessage.messagingToken=this.token_;this.port_.postMessage(this.isWebview_?JSON.stringify(finalMessage):finalMessage)};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.handleRequest_=function(message){var $jscomp$this=this;var handler=this.messageHandlers_[message.name];if(!handler)handler=this.defaultHandler_;if(!handler){var error=new Error("Cannot handle request because no default handler is set!");error.args=message.name;throw error;}var promise=handler(message.name,message.data,!!message.rsvp);if(message.rsvp){var requestId=message.requestid;if(!promise){this.sendResponseError_(requestId,
message.name,new Error("no response"));throw new Error("expected response but none given: "+message.name);}promise.then(function(data){$jscomp$this.sendResponse_(requestId,message.name,data)},function(reason){$jscomp$this.sendResponseError_(requestId,message.name,reason)})}};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.handleResponse_=function(message){var requestId=message.requestid;var pending=this.waitingForResponse_[requestId];if(pending){delete this.waitingForResponse_[requestId];if(message.error){this.logError_(TAG$$module$extensions$amp_viewer_integration$0_1$messaging$messaging+": handleResponse_ error: ",message.error);pending.reject(new Error("Request "+message.name+" failed: "+message.error))}else pending.resolve(message.data)}};
Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.logError_=function(state,opt_data){if(!this.win_)return;var stateStr="amp-messaging-error-logger: "+state;var dataStr=" data: "+this.errorToString_(opt_data);stateStr+=dataStr;this.win_["viewerState"]=stateStr};Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.prototype.errorToString_=function(err){return err?err.message?err.message:String(err):"unknown error"};
var module$extensions$amp_viewer_integration$0_1$messaging$messaging={};module$extensions$amp_viewer_integration$0_1$messaging$messaging.Messaging=Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging;module$extensions$amp_viewer_integration$0_1$messaging$messaging.WindowPortEmulator=WindowPortEmulator$$module$extensions$amp_viewer_integration$0_1$messaging$messaging;module$extensions$amp_viewer_integration$0_1$messaging$messaging.parseMessage=parseMessage$$module$extensions$amp_viewer_integration$0_1$messaging$messaging;var AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host=function(win,ampIframe,frameOrigin,messageHandler,opt_logsId,opt_isWebview,opt_isHandshakePoll){var $jscomp$this=this;this.win=win;this.ampIframe_=ampIframe;this.messageHandler_=messageHandler;this.isWebview_=!!opt_isWebview;this.logsId=opt_logsId;var target=this.ampIframe_.contentWindow;if(this.isWebview_||opt_isHandshakePoll)Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.initiateHandshakeWithDocument(target).then(function(messaging){$jscomp$this.messaging_=
messaging;$jscomp$this.completeHandshake_()});else Messaging$$module$extensions$amp_viewer_integration$0_1$messaging$messaging.waitForHandshakeFromDocument(this.win,target,frameOrigin).then(function(messaging){$jscomp$this.messaging_=messaging;$jscomp$this.completeHandshake_()})};
AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host.prototype.completeHandshake_=function(){this.messaging_.setDefaultHandler(this.messageHandler_);this.sendRequest("visibilitychange",{state:this.visibilityState_,prerenderSize:this.prerenderSize},true)};
AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host.prototype.sendRequest=function(type,data,awaitResponse){this.log("sendRequest");if(!this.messaging_)return;return this.messaging_.sendRequest(type,data,awaitResponse)};AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host.prototype.log=function(){var var_args=Array.prototype.slice.call(arguments,0);var_args.unshift("[ViewerHost "+this.logsId+"]");console.log.apply(console,var_args)};
self.AmpViewerHost=AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host;var module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host={};module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host.AmpViewerHost=AmpViewerHost$$module$extensions$amp_viewer_integration$0_1$examples$amp_viewer_host;})();

//# sourceMappingURL=amp-viewer-host.js.map
