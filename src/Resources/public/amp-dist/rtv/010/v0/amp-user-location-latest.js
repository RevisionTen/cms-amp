(self.AMP=self.AMP||[]).push({n:"amp-user-location",v:"0",f:(function(AMP,_){
var aa="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},k;if("function"==typeof Object.setPrototypeOf)k=Object.setPrototypeOf;else{var l;a:{var ba={a:!0},m={};try{m.__proto__=ba;l=m.a;break a}catch(a){}l=!1}k=l?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var n=k;function ca(){var a,b;this.promise=new Promise(function(c,d){a=c;b=d});this.resolve=a;this.reject=b};function p(a,b){b=void 0===b?"":b;try{return decodeURIComponent(a)}catch(c){return b}};var da=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function q(a){var b=Object.create(null);if(!a)return b;for(var c;c=da.exec(a);){var d=p(c[1],c[1]),f=c[2]?p(c[2].replace(/\+/g," "),c[2]):"";b[d]=f}return b};var r="";
function t(a){var b=a||self;if(b.__AMP_MODE)var c=b.__AMP_MODE;else{c=b;var d=self.AMP_CONFIG||{},f=!!d.test||!1,e=q(c.location.originalHash||c.location.hash);d=d.spt;var g=q(c.location.search);r||(r=c.AMP_CONFIG&&c.AMP_CONFIG.v?c.AMP_CONFIG.v:"010");c={localDev:!1,development:!!(0<=["1","actions","amp","amp4ads","amp4email"].indexOf(e.development)||c.AMP_DEV_MODE),examiner:"2"==e.development,geoOverride:e["amp-geo"],userLocationOverride:e["amp-user-location"],minified:!0,lite:void 0!=g.amp_lite,test:f,
log:e.log,version:"0",rtvVersion:r,singlePassType:d};c=b.__AMP_MODE=c}return c};var ea=Object.prototype.toString;self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var u=self.__AMP_LOG;function v(){if(!u.user)throw Error("failed to call initLogConstructor");return u.user}function w(){if(u.dev)return u.dev;throw Error("failed to call initLogConstructor");}function x(a,b,c,d,f){v().assert(a,b,c,d,f,void 0,void 0,void 0,void 0,void 0,void 0)};var y=Object.prototype.hasOwnProperty;function z(a){return a||{}};function A(){var a=100;this.K=a;this.A=this.F=0;this.o=Object.create(null)}A.prototype.has=function(a){return!!this.o[a]};A.prototype.get=function(a){var b=this.o[a];if(b)return b.access=++this.A,b.payload};A.prototype.put=function(a,b){this.has(a)||this.F++;this.o[a]={payload:b,access:this.A};if(!(this.F<=this.K)){w().warn("lru-cache","Trimming LRU cache");a=this.o;var c=this.A+1,d;for(d in a){var f=a[d].access;if(f<c){c=f;var e=d}}void 0!==e&&(delete a[e],this.F--)}};z({c:!0,v:!0,a:!0,ad:!0,action:!0});var B,C;
function fa(a,b){var c=void 0===c?"source":c;x(null!=a,"%s %s must be available",b,c);var d=a;a=d;if("string"==typeof a){B||(B=self.document.createElement("a"),C=self.__AMP_URL_CACHE||(self.__AMP_URL_CACHE=new A));var f=C,e=B;if(f&&f.has(a))a=f.get(a);else{e.href=a;e.protocol||(e.href=e.href);var g={href:e.href,protocol:e.protocol,host:e.host,hostname:e.hostname,port:"0"==e.port?"":e.port,pathname:e.pathname,search:e.search,hash:e.hash,origin:null};"/"!==g.pathname[0]&&(g.pathname="/"+g.pathname);
if("http:"==g.protocol&&80==g.port||"https:"==g.protocol&&443==g.port)g.port="",g.host=g.hostname;g.origin=e.origin&&"null"!=e.origin?e.origin:"data:"!=g.protocol&&g.host?g.protocol+"//"+g.host:g.href;e=t().test&&Object.freeze?Object.freeze(g):g;f&&f.put(a,e);a=e}}(f="https:"==a.protocol||"localhost"==a.hostname||"127.0.0.1"==a.hostname)||(a=a.hostname,f=a.length-10,f=0<=f&&a.indexOf(".localhost",f)==f);x(f||/^(\/\/)/.test(d),'%s %s must start with "https://" or "//" or be relative and served from either https or from localhost. Invalid value: %s',
b,c,d)};function D(a,b){if(a.__AMP__EXPERIMENT_TOGGLES)var c=a.__AMP__EXPERIMENT_TOGGLES;else{a.__AMP__EXPERIMENT_TOGGLES=Object.create(null);c=a.__AMP__EXPERIMENT_TOGGLES;if(a.AMP_CONFIG)for(var d in a.AMP_CONFIG){var f=a.AMP_CONFIG[d];"number"===typeof f&&0<=f&&1>=f&&(c[d]=Math.random()<f)}if(a.AMP_CONFIG&&Array.isArray(a.AMP_CONFIG["allow-doc-opt-in"])&&0<a.AMP_CONFIG["allow-doc-opt-in"].length&&(d=a.AMP_CONFIG["allow-doc-opt-in"],f=a.document.head.querySelector('meta[name="amp-experiments-opt-in"]'))){f=
f.getAttribute("content").split(",");for(var e=0;e<f.length;e++)-1!=d.indexOf(f[e])&&(c[f[e]]=!0)}Object.assign(c,ha(a));if(a.AMP_CONFIG&&Array.isArray(a.AMP_CONFIG["allow-url-opt-in"])&&0<a.AMP_CONFIG["allow-url-opt-in"].length)for(d=a.AMP_CONFIG["allow-url-opt-in"],a=q(a.location.originalHash||a.location.hash),f=0;f<d.length;f++)e=a["e-"+d[f]],"1"==e&&(c[d[f]]=!0),"0"==e&&(c[d[f]]=!1)}var g=c;return!!g[b]}
function ha(a){var b="";try{"localStorage"in a&&(b=a.localStorage.getItem("amp-experiment-toggles"))}catch(f){w().warn("EXPERIMENTS","Failed to retrieve experiments from localStorage.")}var c=b?b.split(/\s*,\s*/g):[];a=Object.create(null);for(var d=0;d<c.length;d++)0!=c[d].length&&("-"==c[d][0]?a[c[d].substr(1)]=!1:a[c[d]]=!0);return a};var E={},F=(E["ampdoc-fie"]={isTrafficEligible:function(){return!0},branches:[["21065001"],["21065002"]]},E);function G(a,b){var c=a.ownerDocument.defaultView,d=c.__AMP_TOP||(c.__AMP_TOP=c),f=c!=d;var e=d;if(D(e,"ampdoc-fie")){e.__AMP_EXPERIMENT_BRANCHES=e.__AMP_EXPERIMENT_BRANCHES||{};for(var g in F)if(y.call(F,g)&&!y.call(e.__AMP_EXPERIMENT_BRANCHES,g))if(F[g].isTrafficEligible&&F[g].isTrafficEligible(e)){if(!e.__AMP_EXPERIMENT_BRANCHES[g]&&D(e,g)){var h=F[g].branches;e.__AMP_EXPERIMENT_BRANCHES[g]=h[Math.floor(Math.random()*h.length)]||null}}else e.__AMP_EXPERIMENT_BRANCHES[g]=null;e="21065002"===(e.__AMP_EXPERIMENT_BRANCHES?
e.__AMP_EXPERIMENT_BRANCHES["ampdoc-fie"]:null)}else e=!1;var ka=e;f&&!ka?b=H(c,b)?I(c,b):null:(a=J(a),a=K(a),b=H(a,b)?I(a,b):null);return b}function L(a,b){a=a.__AMP_TOP||(a.__AMP_TOP=a);return I(a,b)}function J(a){return a.nodeType?L((a.ownerDocument||a).defaultView,"ampdoc").getAmpDoc(a):a}function K(a){a=J(a);return a.isSingleDoc()?a.win:a}function I(a,b){H(a,b);var c=M(a);a=c[b];a.obj||(a.obj=new a.ctor(a.context),a.ctor=null,a.context=null,a.resolve&&a.resolve(a.obj));return a.obj}
function N(a){var b=M(a)["user-location"];if(b){if(b.promise)return b.promise;I(a,"user-location");return b.promise=Promise.resolve(b.obj)}return null}function M(a){var b=a.__AMP_SERVICES;b||(b=a.__AMP_SERVICES={});return b}function H(a,b){a=a.__AMP_SERVICES&&a.__AMP_SERVICES[b];return!(!a||!a.ctor&&!a.obj)};/*
 https://mths.be/cssescape v1.5.1 by @mathias | MIT license */
function ia(a){return"SCRIPT"==a.tagName&&a.hasAttribute("type")&&"APPLICATION/JSON"==a.getAttribute("type").toUpperCase()};function ja(a){var b=N(K(a));if(b)return b;var c=J(a);return c.waitForBodyOpen().then(function(){var a=c.win;var b=c.win.document.head;if(b){var e={};b=b.querySelectorAll("script[custom-element],script[custom-template]");for(var g=0;g<b.length;g++){var h=b[g];h=h.getAttribute("custom-element")||h.getAttribute("custom-template");e[h]=!0}e=Object.keys(e)}else e=[];a=e.includes("amp-user-location")?L(a,"extensions").waitForExtension(a,"amp-user-location"):Promise.resolve();return a}).then(function(){return N(K(a))})}
;function la(a,b){try{return JSON.parse(a)}catch(c){return b&&b(c),null}};function ma(a,b){var c=".",d=2,f;c=void 0===c?".":c;d=void 0===d?0:d;var e=void 0===e?!1:e;fa(b.getAttribute("src"),b);var g=L(a.win,"batched-xhr");return na(b,d,e).then(function(a){void 0!==f&&(a.fetchOpt.method="POST",a.fetchOpt.headers={"Content-Type":"application/x-www-form-urlencoded"},a.fetchOpt.body={ampViewerAuthToken:f});return g.fetchJson(a.xhrUrl,a.fetchOpt)}).then(function(a){return a.json()}).then(function(a){if(null==a)throw Error("Response is undefined.");var b=c||".";if("."==b)b=a;
else{b=b.split(".");for(var d=0;d<b.length;d++){var e=b[d];if(e&&a&&void 0!==a[e]&&(null==a||"object"!=typeof a?0:Object.prototype.hasOwnProperty.call(a,e)))a=a[e];else{a=void 0;break}}b=a}return b})}
function na(a,b,c){var d=a.getAttribute("src"),f=G(a,"url-replace");return(1<=b?f.expandUrlAsync(d):Promise.resolve(d)).then(function(d){if(1==b){var e=f.collectUnwhitelistedVarsSync(a);if(0<e.length)throw v().createError('URL variable substitutions in CORS fetches from dynamic URLs (e.g. via amp-bind) require opt-in. Please add data-amp-replace="'+(e.join(" ")+'" to the <')+(a.tagName+"> element. See https://bit.ly/amp-var-subs."));}var h={};a.hasAttribute("credentials")&&(h.credentials=a.getAttribute("credentials"));
c&&(h.cache="reload");return{xhrUrl:d,fetchOpt:h}})};function O(a,b){this.J=a;this.j=b;this.D=this.C=null}O.prototype.getConfig=function(){var a=this;return 0<this.j.children.length&&!this.j.hasAttribute("src")?P(this):0<this.j.children.length&&this.j.hasAttribute("src")?Promise.race([Promise.resolve().then(function(){return a.fetchConfig()}),Promise.resolve().then(function(){return P(a)})]):this.j.hasAttribute("src")?this.fetchConfig():Promise.resolve({})};
function P(a){if(!(0<a.j.children.length))return Promise.resolve({});if(a.D)return a.D;var b=a.j,c=b.children,d=b.tagName;x(1==c.length,"%s may only have one configuration json <script> tag",d);var f=c[0];return ia(f)?a.D=new Promise(function(b,c){var d=la(f.textContent,function(a){c(a)});if(!d)return b({});b(Q(a,d))}):(v().error(d,'config should be in a <script> tag with type="application/json".'),Promise.resolve({}))}
O.prototype.fetchConfig=function(){return this.j.hasAttribute("src")?this.C?this.C:this.C=oa(this):Promise.resolve({})};function oa(a){return ma(a.J,a.j).then(function(b){return Q(a,b)})}function Q(a,b){x(!Array.isArray(b)&&"[object Object]"===ea.call(b),"expected %s configuration to be object",a.j.tagName);return b};function R(){this.h=null}R.prototype.add=function(a){var b=this;this.h||(this.h=[]);this.h.push(a);return function(){b.remove(a)}};R.prototype.remove=function(a){this.h&&(a=this.h.indexOf(a),-1<a&&this.h.splice(a,1))};R.prototype.removeAll=function(){this.h&&(this.h.length=0)};R.prototype.fire=function(a){if(this.h)for(var b=this.h,c=0;c<b.length;c++)(0,b[c])(a)};R.prototype.getHandlerCount=function(){return this.h?this.h.length:0};function S(a,b,c){this.source=a;this.lat=b;this.lon=c};function T(a){this.H=!1;this.w=null;this.I=U(this);this.m=new ca;var b=a.win;this.l=b;a=J(a);a=K(a);var c=I(a,"viewer"),d=L(b,"platform"),f=!(c.isEmbedded()&&d.isChrome());this.L=f&&"geolocation"in b.navigator;this.M="permissions"in b.navigator}function U(a){var b=new R;b.add(function(b){var c=b;a.w=c;a.m&&a.m.resolve(c)});return b}
function pa(a){if(a.M){var b=a.l.navigator.permissions.query({name:"geolocation"});b.then(function(b){b.addEventListener("change",function(b){var c=b.target.state;"granted"!==c&&a.purge()})})}}T.prototype.purge=function(){this.m=this.w=null;this.I=U(this)};T.prototype.getLocation=function(a){a=void 0===a?!1:a;var b=V(this);return b?b.catch(function(a){return 4==a.code?new S("unsupported"):new S("unavailable")}):a&&this.m?this.m.promise:this.w?Promise.resolve(this.w):Promise.resolve(new S("unavailable"))};
T.prototype.getReplacementLocation=function(a,b,c){return this.getLocation(void 0===c?!1:c).then(function(c){if("SOURCE"===b)return c.source;if("LAT"===b)return c.lat;if("LON"===b)return c.lon;x(""===b||"undefined"===typeof b,"The value passed to %s is not valid: %s",a,b);return"geolocation"!==c.source?"":c.lat+","+c.lon})};
T.prototype.requestLocation=function(a){var b=a.fallback,c=V(this);if(c)return c.catch(function(a){return qa(a,b)});this.H||(this.H=!0,pa(this));a=ra(this.l,{enableHighAccuracy:!1,maximumAge:a.maximumAge||6E4,timeout:a.timeout||(t().localDev?3E4:5E3)});var d=this.I;a.then(function(a){return d.fire(a)},function(){return d.fire(new S("unavailable"))});return a.catch(function(a){return qa(a,b)})};
function V(a){var b;if(!a.L)return a=Error("geolocation error"),a.code=4,Promise.reject(a);if(b=t(a.l).userLocationOverride)b=a.l,b=!(!b.AMP_CONFIG||!b.AMP_CONFIG.canary)||t(a.l).localDev;b&&/^[\w-,]+$/.test(t(a.l).userLocationOverride)?"error"===t(a.l).userLocationOverride?(a=Error("geolocation simulated error"),a.code=2):(b=t(a.l).userLocationOverride.split(","),a=Number(b[0]),b=Number(b[1]),a=new S("debug",a,b)):a=null;var c=a;return c?c instanceof Error?Promise.reject(c):Promise.resolve(c):null}
function qa(a,b){b&&(a.fallback=new S("fallback",b.lat,b.lon));return Promise.reject(a)}function ra(a,b){return new Promise(function(c,d){a.navigator.geolocation.getCurrentPosition(function(a){a=a.coords;var b=a.latitude,d=a.longitude;c(new S("geolocation",b,d))},function(a){var b=Error("geolocation failed");switch(a.code){case a.POSITION_UNAVAILABLE:b.code=2;break;case a.PERMISSION_DENIED:b.code=1;break;case a.TIMEOUT:b.code=3}d(b)},b)})};function W(a){a=AMP.BaseElement.call(this,a)||this;a.B=null;a.G=null;return a}var X=AMP.BaseElement;W.prototype=aa(X.prototype);W.prototype.constructor=W;if(n)n(W,X);else for(var Y in X)if("prototype"!=Y)if(Object.defineProperties){var sa=Object.getOwnPropertyDescriptor(X,Y);sa&&Object.defineProperty(W,Y,sa)}else W[Y]=X[Y];W.N=X.prototype;W.prototype.isLayoutSupported=function(a){return"nodisplay"==a};
W.prototype.buildCallback=function(){var a=this;x(D(this.win,"amp-user-location"),'The "amp-user-location" experiment must be enabled to use amp-user-location');this.B=new O(this.getAmpDoc(),this.element);this.G=G(this.element,"action");this.registerAction("request",function(){return ta(a)},100)};W.prototype.layoutCallback=function(){this.B.fetchConfig();return Promise.resolve()};
function ta(a){return Promise.all([ja(a.element),ua(a)]).then(function(a){var b=a[0];return b.requestLocation(a[1])}).then(function(b){Z(a,"approve",b)},function(b){switch(b.code){case 1:Z(a,"deny",z({fallback:b.fallback}));break;default:Z(a,"error",z({fallback:b.fallback}))}})}
function ua(a){return a.B.getConfig().then(function(a){var b=a.fallback;if("string"===typeof b){var d=b.split(",");d={lat:Number(d[0]),lon:Number(d[1])}}"object"===typeof b&&(d={lat:b.lat,lon:b.lon});return{fallback:d,maximumAge:a.maximumAge,precision:a.precision,timeout:a.timeout}}).catch(function(){var b=Error("Failed to parse amp-user-location config. Is it valid JSON?");a.user().error("amp-user-location",b);throw b;})}
function Z(a,b,c){var d=a.win,f="amp-user-location."+b,e={detail:c};Object.assign(e,void 0);"function"==typeof d.CustomEvent?c=new d.CustomEvent(f,e):(d=d.document.createEvent("CustomEvent"),d.initCustomEvent(f,!!e.bubbles,!!e.cancelable,c),c=d);a.G.trigger(a.element,b,c,100)}(function(a){a.registerElement("amp-user-location",W);a.registerServiceForDoc("user-location",T)})(self.AMP);
})});

//# sourceMappingURL=amp-user-location-0.1.js.map
